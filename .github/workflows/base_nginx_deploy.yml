name: Base Nginx Deploy

on:
  workflow_call:
    inputs:
      versionToBuild:
        required: true
        type: string
      environment:
        required: true
        type: string
    secrets:
      REPO_TOKEN:
        required: true
      EC2_IP:
        required: true
      AWS_ACCESS_KEY:
        required: true
      AWS_SECRET_KEY:
        required: true
      AWS_REGION:
        required: true
      EC2_USER:
        required: true
      SECURITY_GROUP_ID:
        required: true
      SSH_PRIVATE_KEY_FOR_EC2:
        required: true
      DOMAIN_NAME:
        required: true

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}

    steps:
      # Checkout current repo (for actions)
      - name: Checkout repo
        uses: actions/checkout@v4

      # Checkout only nginx folder from main repo
      - name: Checkout nginx config
        uses: actions/checkout@v4
        with:
          repository: WonderWhyDev/wonderWhy
          token: ${{ secrets.REPO_TOKEN }}
          path: wonderWhy
          fetch-depth: 1
          sparse-checkout: nginx
          sparse-checkout-cone-mode: false
          ref: ${{ inputs.versionToBuild }}

      # Environment-specific config
      - name: Update network name for QA
        if: ${{ inputs.environment == 'qa' }}
        run: |
          sed -i 's|name: wonderwhy_postgres-network|name: wonderwhy-network|' \
          wonderWhy/nginx/compose.yml

      # Configure AWS credentials
      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ap-south-1

      # Fetch SSL certs from AWS Secrets Manager
      - name: Fetch SSL Certificates
        run: |
          set -e

          mkdir -p wonderWhy/nginx/certs
          mkdir -p wonderWhy/nginx/site/certs

          # Fetch certs from AWS Secrets Manager
          aws secretsmanager get-secret-value \
            --secret-id CA_CERTS_FULL_CHAIN \
            --query SecretString \
            --output text | jq -r '.cert' | base64 -d \
            > wonderWhy/nginx/certs/fullchain.pem

          aws secretsmanager get-secret-value \
            --secret-id CA_CERTS_PRIVATE_KEY \
            --query SecretString \
            --output text | jq -r '.key' | base64 -d \
            > wonderWhy/nginx/certs/privkey.pem

          # Copy same certs for site
          cp wonderWhy/nginx/certs/fullchain.pem wonderWhy/nginx/site/certs/fullchain.pem
          cp wonderWhy/nginx/certs/privkey.pem wonderWhy/nginx/site/certs/privkey.pem

          chmod 600 wonderWhy/nginx/certs/*.pem wonderWhy/nginx/site/certs/*.pem

      # Zip nginx folder
      - name: Package nginx
        run: |
          cd wonderWhy
          zip -r nginx.zip nginx

      # Copy to EC2 & deploy
      - name: Copy nginx to EC2 and deploy
        uses: ./.github/actions/copy_to_ec2
        with:
          ec2IP: ${{ secrets.EC2_IP }}
          awsAccessKeyId: ${{ secrets.AWS_ACCESS_KEY }}
          awsSecretKey: ${{ secrets.AWS_SECRET_KEY }}
          awsRegion: ${{ secrets.AWS_REGION }}
          ec2User: ${{ secrets.EC2_USER }}
          securityGroupId: ${{ secrets.SECURITY_GROUP_ID }}
          sshKey: ${{ secrets.SSH_PRIVATE_KEY_FOR_EC2 }}
          fileToCopy: ./wonderWhy/nginx.zip
          destination: ~/nginx.zip
          unzipDestination: ~/
          runScript: |
            cd nginx
            sh deploy.sh ${{ secrets.DOMAIN_NAME }}
