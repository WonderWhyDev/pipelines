name: Certs Generation for Vijay
run-name: ssl certs for vijay.wondermove.in

on:
  workflow_dispatch:

jobs:
  generate-certificate:
    runs-on: ubuntu-latest
    environment: 'magnum'

    steps:
    - uses: actions/checkout@v2

    - name: Install Certbot
      run: |
        sudo apt-get update
        sudo apt-get install -y certbot python3-certbot-dns-route53

    - name: Configure AWS CLI
      uses: aws-actions/configure-aws-credentials@v2
      with:
       aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
       aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
       aws-region: us-east-1

    - name: Generate SSL Certificate for vijay.wondermove.in
      run: |
        certbot certonly \
          --dns-route53 \
          --agree-tos \
          --non-interactive \
          --dns-route53-propagation-seconds 60 \
          --email thinker@wonderwhy.in \
          --config-dir ./ \
          --work-dir ./ \
          --logs-dir /tmp \
          --key-type rsa \
          --rsa-key-size 4096 \
          -d vijay.wondermove.in

    - name: Zip Certificates
      run: |
        zip -j vijay_certs.zip ./live/vijay.wondermove.in/fullchain.pem ./live/vijay.wondermove.in/privkey.pem

    - name: Copy Certificates to EC2
      uses: ./.github/actions/copy_to_ec2
      with:
        ec2IP: ${{ secrets.EC2_IP }}
        awsAccessKeyId: ${{ secrets.AWS_ACCESS_KEY }}
        awsSecretKey: ${{ secrets.AWS_SECRET_KEY }}
        awsRegion: ${{ secrets.AWS_REGION }}
        ec2User: ${{ secrets.EC2_USER }}
        securityGroupId: ${{ secrets.SECURITY_GROUP_ID }}
        sshKey: ${{ secrets.SSH_PRIVATE_KEY_FOR_EC2 }}
        fileToCopy: ./vijay_certs.zip
        destination: ~/vijay_certs.zip
        runScript: |
          cd ~/nginx/certs
          mkdir -p vijay
          unzip -o ~/vijay_certs.zip -d vijay
          rm ~/vijay_certs.zip


